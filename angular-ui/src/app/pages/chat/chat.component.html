<div class="chat-container">
  <div class="chat-sidebar">
    <div class="model-selector">
      <h3>模型设置</h3>
      
      <div class="form-group">
        <label for="llm">LLM 提供商</label>
        <select id="llm" [ngModel]="selectedLlm()" (ngModelChange)="updateLlm($event)">
          <option value="ollama">Ollama</option>
          <option value="openai">OpenAI</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="model">模型</label>
        <select id="model" [ngModel]="selectedModel()" (ngModelChange)="updateModel($event)">
          @if (selectedLlm() === 'ollama') {
            <option value="deepseek-r1:8b">Deepseek R1</option>
            <option value="llama3">Llama 3</option>
          }
          @if (selectedLlm() === 'openai') {
            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
            <option value="gpt-4o">GPT-4o</option>
            <option value="glm-4.5">glm-4.5</option>
          }
        </select>
      </div>
      
      <div class="form-group rag-toggle">
        <label for="useRag">使用知识库</label>
        <div class="toggle-switch">
          <input type="checkbox" id="useRag" [ngModel]="useRag()" (ngModelChange)="toggleRag($event)">
          <label for="useRag" class="toggle-label"></label>
        </div>
      </div>
      
      @if (useRag()) {
        <div class="form-group">
          <label for="ragTag">知识库</label>
          <select id="ragTag" [ngModel]="selectedRagTag()" (ngModelChange)="updateRagTag($event)">
            @for (tag of ragTags(); track tag) {
              <option [value]="tag">{{ tag }}</option>
            }
          </select>
        </div>
      }
      
      <button class="clear-button" (click)="clearChat()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
        </svg>
        清空聊天
      </button>
    </div>
  </div>
  
  <div class="chat-main">
    <div class="messages-container" #messagesContainer>
      @for (message of messages(); track message.id) {
        <div [ngClass]="{
          'message': true,
          'user-message': message.type === 'user',
          'ai-message': message.type === 'ai',
          'error': message.error
        }">
          <div class="message-avatar">
            @if (message.type === 'user') {
              <div class="user-avatar">用户</div>
            }
            @if (message.type === 'ai') {
              <div class="ai-avatar">AI</div>
            }
          </div>
          <div class="message-content">
            <div class="message-header">
              <span class="message-sender">{{ message.type === 'user' ? '用户' : 'AI 助手' }}</span>
              <span class="message-time">{{ message.timestamp | date:'HH:mm' }}</span>
            </div>
            <div class="message-body">
              @if (message.isThinking) {
                <div class="thinking-indicator">
                  <span>思考中...</span>
                </div>
              }
              @if (!message.isThinking || message.content) {
                <markdown [data]="message.content" [inline]="false"></markdown>
              }
              @if (message.error) {
                <div class="error-actions">
                  <button class="retry-button" (click)="retryLastMessage()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                      <path d="M21 3v5h-5"></path>
                      <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                      <path d="M3 21v-5h5"></path>
                    </svg>
                    重试
                  </button>
                </div>
              }
              @if (message.isStreaming) {
                <div class="typing-indicator">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              }
            </div>
          </div>
        </div>
      }
    </div>
    
    <div class="message-input-container">
      <textarea 
        [ngModel]="newMessage()" 
        (ngModelChange)="updateNewMessage($event)"
        placeholder="输入你的问题..." 
        (keydown)="handleEnterKey($event)"
        [disabled]="isLoading()"
      ></textarea>
      <button (click)="sendMessage()" [disabled]="!canSendMessage()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>
</div>